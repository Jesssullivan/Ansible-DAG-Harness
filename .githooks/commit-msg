#!/usr/bin/env bash
# Commit-msg hook: Enforce commit message standards
#
# Installation:
#   git config core.hooksPath .githooks

set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# =============================================================================
# Block AI Attribution
# =============================================================================

if echo "$COMMIT_MSG" | grep -Eqi "ai-generated|ai-assisted|co-authored-by.*(ai|llm|claude|gpt|copilot|bot|anthropic)"; then
    echo "ERROR: AI attribution detected in commit message"
    echo "Remove AI-related Co-Authored-By or attribution lines"
    exit 1
fi

# Simple Co-Authored-By block (catches all)
if echo "$COMMIT_MSG" | grep -qi "co-authored-by"; then
    echo "ERROR: Co-Authored-By lines are not allowed in this repository."
    echo "Please remove the Co-Authored-By line from your commit message."
    exit 1
fi

# =============================================================================
# Conventional Commits Format (Optional - set ENFORCE_CONVENTIONAL=1)
# =============================================================================

ENFORCE_CONVENTIONAL="${ENFORCE_CONVENTIONAL:-0}"

if [ "$ENFORCE_CONVENTIONAL" = "1" ]; then
    CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?: .{1,72}"
    FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)

    if ! echo "$FIRST_LINE" | grep -Eq "$CONVENTIONAL_PATTERN"; then
        echo "ERROR: Commit message does not follow Conventional Commits format"
        echo ""
        echo "Expected format: type(scope): description"
        echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
        echo "Example: feat(auth): add OAuth2 login support"
        echo ""
        echo "Your message: $FIRST_LINE"
        exit 1
    fi
fi

exit 0
