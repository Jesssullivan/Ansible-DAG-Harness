#!/usr/bin/env bash
# Pre-commit hook: Block AI artifacts and enforce coding standards
#
# Installation:
#   git config core.hooksPath .githooks

set -euo pipefail

echo "Running pre-commit checks..."

# =============================================================================
# AI Attribution Blocking
# =============================================================================

if git diff --cached | grep -qi "co-authored-by.*\(ai\|llm\|assistant\|bot\|claude\|gpt\|copilot\)"; then
    echo "ERROR: AI co-authoring detected in commit"
    echo "Remove Co-Authored-By lines referencing AI/LLM tools"
    exit 1
fi

# Block AI-related files from being committed (except CLAUDE.md which is project docs)
AI_PATTERNS=(
    "^\.claude/"
    "^\.mcp\.json"
    "^\.steering/"
    "^\.hive-mind/"
    "^\.swarm/"
    "^\.cursor/"
    "^\.aider"
    "^\.continue/"
)

for pattern in "${AI_PATTERNS[@]}"; do
    if git diff --cached --name-only | grep -Ei "$pattern"; then
        echo "ERROR: AI-related file detected matching: $pattern"
        echo "These files should not be committed to the repository"
        exit 1
    fi
done

# =============================================================================
# Secret Detection
# =============================================================================

SECRET_PATTERNS=(
    "PRIVATE.KEY"
    "-----BEGIN.*PRIVATE"
    "password\s*=\s*['\"][^'\"]{8,}"
    "api.key\s*=\s*['\"][^'\"]{16,}"
    "AWS_SECRET"
    "GITLAB_TOKEN"
)

for pattern in "${SECRET_PATTERNS[@]}"; do
    if git diff --cached | grep -Eqi "$pattern"; then
        echo "ERROR: Potential secret detected matching: $pattern"
        echo "Please remove sensitive data before committing"
        exit 1
    fi
done

# =============================================================================
# File Size Check
# =============================================================================

while IFS= read -r file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 1048576 ]; then
            echo "WARNING: Large file detected: $file (${size} bytes)"
            echo "Consider using Git LFS for large binary files"
        fi
    fi
done < <(git diff --cached --name-only)

echo "Pre-commit checks passed"
exit 0
