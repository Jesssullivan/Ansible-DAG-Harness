# GitLab CI/CD Pipeline for DAG Harness
# Mirrors GitHub Actions for full parity

stages:
  - lint
  - test
  - build
  - publish
  - pages

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"
  GIT_CLONE_PATH: "$CI_BUILDS_DIR/$CI_CONCURRENT_ID/$CI_PROJECT_NAME"
  GIT_CLEAN_FLAGS: "-ffdx"

.uv-cache: &uv-cache
  cache:
    key:
      files:
        - harness/pyproject.toml
        - harness/uv.lock
      prefix: "uv-$CI_JOB_NAME"
    paths:
      - .cache/uv
      - harness/.venv
    policy: pull-push

.local-runner: &local-runner
  tags:
    - docker
    - m1
    - tinyland

# ============================================================================
# LINT STAGE
# ============================================================================

lint:ruff:
  stage: lint
  image: python:3.12
  <<: [*uv-cache, *local-runner]
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev
    - uv run ruff check harness/ tests/
    - uv run ruff format --check harness/ tests/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint:shellcheck:
  stage: lint
  image: koalaman/shellcheck-alpine
  <<: *local-runner
  script:
    - shellcheck scripts/*.sh || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

type-check:
  stage: lint
  image: python:3.12
  <<: [*uv-cache, *local-runner]
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev
    - uv run mypy harness/ --config-file pyproject.toml || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================================================
# TEST STAGE
# ============================================================================

.test-base: &test-base
  stage: test
  <<: [*uv-cache, *local-runner]
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev || (rm -rf .venv && uv sync --extra dev)
    - uv run pytest -v --cov=harness --cov-report=xml --cov-report=term-missing -m "not integration and not slow and not e2e"
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: harness/coverage.xml
    expire_in: 1 week

test:python-3.11:
  <<: *test-base
  image: python:3.11
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:python-3.12:
  <<: *test-base
  image: python:3.12
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test-pbt:
  stage: test
  image: python:3.12
  <<: [*uv-cache, *local-runner]
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev
    - uv run pytest -m pbt --hypothesis-show-statistics -v
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================================================
# SECURITY
# ============================================================================

sast:bandit:
  stage: test
  image: python:3.12
  <<: *local-runner
  script:
    - pip install bandit[toml]
    - bandit -r harness/harness -f json -o bandit-report.json || true
  artifacts:
    paths:
      - bandit-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# BUILD STAGE
# ============================================================================

build-docs:
  stage: build
  image: python:3.12
  <<: *local-runner
  script:
    - pip install uv mkdocs mkdocs-material pymdown-extensions mkdocstrings mkdocstrings-python
    - cd harness && uv pip install --system -e . && cd ..
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================================================
# PAGES & PUBLISH
# ============================================================================

pages:
  stage: pages
  needs: [build-docs]
  <<: *local-runner
  script:
    - echo "Deploying to GitLab Pages"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

publish-pypi:
  stage: publish
  image: python:3.12
  <<: *local-runner
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
  script:
    - pip install uv twine
    - cd harness
    - uv sync --extra dev
    - uv build
    - uv run twine upload dist/*
